import streamlit as st
import pandas as pd
from streamlit_option_menu import option_menu
from pathlib import Path
import requests
import base64
import os
import subprocess







# ë°ì´í„° ì¤€ë¹„
data = pd.read_csv("./data/í•©ì¹œê±°.csv")




# htmlë“¤ ì—°ê²°
local_codes_html = Path('./htmls/local_codes.html')
korea_html = Path('./htmls/korea.html')




#ì„œë²„ ì£¼ì†Œ
my_url = 'http://127.0.0.1:8000/'

#ì¿¼ë¦¬ë¬¸ ì €ì¥
query_params = st.query_params



#í˜ì´ì§€ ìƒì„±
st.set_page_config(page_title='ì¤‘ìš”í•˜ì§€ ì•Šì•„', page_icon='ğŸŒ')



#ì‚¬ì´ë“œ ë°”
with st.sidebar:

    choice = option_menu("Menu", ["í™ˆ", "ê¸°ì¡´ ë°œì „ëŸ‰", "ê·¸ë˜í”„ë“¤", "ì§€ì—­ë³„ ì˜ˆì¸¡"],
                         icons=['house', 'bar-chart-line', 'bi bi-robot', 'map'],
                         menu_icon="app-indicator", default_index=0,
                         styles={
        "container": {"padding": "4!important", "background-color": "#fafafa"},
        "icon": {"color": "black", "font-size": "25px"},
        "nav-link": {"font-size": "16px", "text-align": "left", "margin":"0px", "--hover-color": "#fafafa"},
        "nav-link-selected": {"background-color": "#08c7b4"},
    }
    )

    #ì§€ì—­ì´ ì„ íƒë˜ë©´ ì§€ì—­ë³„ ì˜ˆì¸¡ìœ¼ë¡œ ê³ ì •
    if 'region' in query_params:
        choice = 'ì§€ì—­ë³„ ì˜ˆì¸¡'
        
    

#í™ˆ
if choice=='í™ˆ':
    st.header('"ì¤‘ìš”í•˜ì§€ ì•Šì•„"ì˜ í”Œë«í¼ì— ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!')

    st.divider()

    st.subheader('ğŸ˜ê°œìš”')
    '''
    ë³¸ í”Œë«í¼ì—ì„œëŠ” 2013ë…„01ì›”01ì¼ ~ 2017ë…„02ì›”28ì¼ì— ì¸¡ì •ëœ íƒœì–‘ê´‘ë°œì „ëŸ‰ë°ì´í„°ì™€
    í•´ë‹¹ ì§€ì—­ë³„ ê¸°ìƒë°ì´í„°ë¥¼ ì´ìš©í•˜ì—¬ AIëª¨ë¸ì—ê²Œ í•™ìŠµì‹œí‚¨ í›„, ì´ í›„ì˜ íƒœì–‘ê´‘ë°œì „ëŸ‰ë°ì´í„°ë¥¼ 
    ì˜ˆì¸¡í•˜ì˜€ìŠµë‹ˆë‹¤.
    '''
    
    ''

    st.subheader('ğŸ’¸í™œìš©ì„±')
    '''
    íƒœì–‘ê´‘ìœ¼ë¡œ ë°œì „í•œ ì „ê¸°ë¥¼ ì „ë ¥ì‹œì¥ì— ìœ í†µí•  ë•Œ íŠ¹ì • ê¸°ê°„ë™ì•ˆì˜ ì˜ˆì¸¡ëœ ë°œì „ëŸ‰ì„ ì œì¶œí•œ í›„
    ì‹¤ì œ ë°œì „ëŸ‰ê³¼ ì˜¤ì°¨ê°€ ì ì€ ë§Œí¼ ê°€ê²©ì´ ì˜¬ë¼ê°„ë‹¤ê³  í•©ë‹ˆë‹¤! ê·¸ëŸ¼ ì˜ˆì¸¡ëœ ë°œì „ëŸ‰ì´ ì •í™•í• ìˆ˜ë¡
    ë” í° ì´ìœ¤ì„ ë‚¨ê¸¸ ìˆ˜ ìˆê² ì£ ! 
    '''

    if st.button('ëˆ„ë¥´ë©´ ì„œë²„ì™€ í†µì‹ 1'):
        response = requests.get(my_url)

        st.title('ì„œë²„ì—ì„œ ë³´ë‚¸ ê²ƒ:')
        st.subheader(response.content)

    if st.button('ëˆ„ë¥´ë©´ ì„œë²„ì™€ í†µì‹ 2'):
        response = requests.get(my_url+'items/3')

        st.title('ì„œë²„ì—ì„œ ë³´ë‚¸ ê²ƒ:')
        st.subheader(response.json()['item_id'])

    
    
#ë°œì „ëŸ‰ ì˜ˆì¸¡
elif choice=='ê¸°ì¡´ ë°œì „ëŸ‰':

    
    #ì§€ì—­ì½”ë“œë³´ì—¬ì£¼ëŠ” htmlíŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    if local_codes_html.exists():
        st.html(local_codes_html)
    else:
        st.error('html íŒŒì¼ì´ ì—†ìŒ')
    ''

    #ì§€ì—­ codeë“¤
    locals = data['code'].unique()

    #ì›í•˜ëŠ” ì§€ì—­ì½”ë“œë“¤ ì„ íƒ
    selected_locals = st.multiselect(
        'ë³´ê³ ì‹¶ì€ ì§€ì—­ë“¤ì„ ì„ íƒí•˜ì„¸ìš”!',
        locals,
        ['KSN','KSB','KWJ'])
    
    filtered_data = data[data['code'].isin(selected_locals)]
    
    ''
    st.header('ê¸°ì¡´ íƒœì–‘ê´‘ ë°œì „ëŸ‰ ê·¸ë˜í”„')
    st.line_chart(filtered_data,x='datetime',y='Solar_Power(MWh)', color = 'code')

    


#í˜ì´ì§€3
elif choice=='ê·¸ë˜í”„ë“¤':
    st.header('ì—¬ëŸ¬ê°€ì§€ ê·¸ë˜í”„')

    tab1, tab2, tab3 = st.tabs(['ë§‰ëŒ€','ì˜ì—­','ì '])

    with tab1:
        st.header('ë§‰ëŒ€ê·¸ë˜í”„')
        st.bar_chart(data,x='datetime',y='Solar_Power(MWh)', color = 'code')

    with tab2:
        st.header('ì˜ì—­ê·¸ë˜í”„')
        st.area_chart(data,x='datetime',y='Solar_Power(MWh)', color = 'code')

    with tab3:
        st.header('ì ê·¸ë˜í”„')
        st.scatter_chart(data,x='datetime',y='Solar_Power(MWh)', color = 'code')
        

elif choice=='ì§€ì—­ë³„ ì˜ˆì¸¡':      

    

    st.header('ì›í•˜ëŠ” ì§€ì—­ì„ í´ë¦­í•˜ë©´ ë°‘ì— ì˜ˆì¸¡ëŸ‰ì´ ë³´ì—¬ì§‘ë‹ˆë‹¤')
    
    
    
    # ì´ë¯¸ì§€íƒœê·¸ê°€ ì•ˆë¼ì„œ ì´ë¯¸ì§€ë¥¼ base64ë¡œ ì¸ì½”ë”©
    file_ = open("./img/korea_map.png", "rb")
    contents = file_.read()
    data_url = base64.b64encode(contents).decode("utf-8")
    file_.close()
    

    st.html(
        f'''<div>
            <img class="korea_map" src="data:image/png;base64,{data_url}" alt="korea_map" usemap="#image-map">
                <map name="image-map">
                    <area target="_blank" alt="ì„œìš¸" title="ì„œìš¸" href="?region=seoul" coords="269,250,267,236,247,243,230,254,222,261,233,277,250,285,273,280,281,263" shape="poly">
                    <area target="_self" alt="ì¸ì²œ" title="ì¸ì²œ" href="?region=incheon" coords="214,257,197,242,188,253,194,270,202,283,205,289,215,280" shape="poly">
                    <area target="_self" alt="ê²½ê¸°ë„" title="ê²½ê¸°ë„" href="ê²½ê¸°ë„ë§í¬" coords="358,192,333,166,324,148,313,155,301,140,285,121,269,116,238,136,237,159,230,172,223,189,211,203,213,224,195,216,165,216,159,232,162,243,177,243,198,236,217,243,233,244,265,227,277,239,283,249,289,263,283,278,270,288,254,292,235,290,220,269,219,291,208,300,213,308,185,324,197,336,219,343,215,366,230,384,248,389,274,381,299,391,326,370,349,355,367,335,379,289,384,268,345,250,336,220,343,203" shape="poly">
                    <area target="_self" alt="ê°•ì›ë„" title="ê°•ì›ë„" href="ê°•ì›ë„ë§í¬" coords="642,360,609,292,595,242,488,53,468,94,389,106,298,105,289,113,301,132,322,142,343,164,363,191,355,212,348,230,362,248,396,270,388,287,381,328,381,342,401,342,417,328,438,331,481,339,522,361" shape="poly">
                    <area target="_self" alt="ì¶©ì²­ë‚¨ë„" title="ì¶©ì²­ë‚¨ë„" href="ì¶©ì²­ë‚¨ë„ë§í¬" coords="309,424,273,391,221,404,176,372,161,381,151,376,155,393,136,403,129,388,102,421,121,431,137,451,158,440,171,472,169,500,167,548,197,573,233,547,271,559,302,563,314,580,327,581,340,576,338,560,336,541,309,545,285,536,277,513,278,488,266,456,265,430" shape="poly">
                    <area target="_self" alt="ì¶©ì²­ë¶ë„" title="ì¶©ì²­ë¶ë„" href="ì¶©ì²­ë¶ë„ë§í¬" coords="520,369,465,356,453,341,429,348,415,339,405,352,372,352,356,366,338,376,313,392,301,402,318,417,321,434,305,437,311,452,316,466,318,476,332,488,339,502,333,531,349,564,369,573,384,573,398,571,401,549,410,537,391,529,381,512,385,481,379,456,391,447,439,409,481,415" shape="poly">
                    <area target="_self" alt="ëŒ€ì „" title="ëŒ€ì „" href="ëŒ€ì „ë§í¬" coords="333,502,317,494,308,486,295,499,289,519,297,534,308,527,317,539,323,532" shape="poly">
                    <area target="_self" alt="ì„¸ì¢…" title="ì„¸ì¢…" href="ì„¸ì¢…ë§í¬" coords="310,467,292,451,293,438,273,438,280,466,288,488,300,485" shape="poly">
                    <area target="_self" alt="ê²½ìƒë¶ë„" title="ê²½ìƒë¶ë„" href="ê²½ìƒë¶ë„ë§í¬" coords="644,363,602,380,527,381,499,412,470,430,453,422,429,431,429,448,410,448,401,469,393,467,401,524,425,540,416,558,401,587,413,617,442,635,447,652,468,658,472,623,493,586,532,584,542,609,537,646,520,654,508,659,514,667,538,670,578,661,608,647,635,655,656,659,670,593,639,591,654,494,659,420" shape="poly">
                    <area target="_self" alt="ê²½ìƒë‚¨ë„" title="ê²½ìƒë‚¨ë„" href="ê²½ìƒë‚¨ë„ë§í¬" coords="607,715,570,684,572,675,503,678,490,666,441,666,430,652,433,641,392,615,357,629,342,674,352,704,337,732,369,786,356,807,409,784,422,810,456,808,464,817,483,778,501,779,515,767,534,768" shape="poly">
                    <area target="_self" alt="ìš¸ì‚°" title="ìš¸ì‚°" href="ìš¸ì‚°ë§í¬" coords="648,699,654,672,629,666,600,657,584,682,611,705,629,726" shape="poly">
                    <area target="_self" alt="ëŒ€êµ¬" title="ëŒ€êµ¬" href="ëŒ€êµ¬ë§í¬" coords="521,643,530,614,524,592,497,610,485,610,490,631,481,644,482,662" shape="poly">
                    <area target="_self" alt="ì „ë¼ë¶ë„" title="ì „ë¼ë¶ë„" href="ì „ë¼ë¶ë„ë§í¬" coords="377,582,319,590,289,570,246,571,228,558,195,585,173,597,205,606,197,631,149,657,179,673,140,694,153,713,180,707,195,681,220,704,247,693,253,720,285,720,315,716,333,716,336,658,351,626,380,608" shape="poly">
                    <area target="_self" alt="ì „ë¼ë‚¨ë„" title="ì „ë¼ë‚¨ë„" href="ì „ë¼ë‚¨ë„ë§í¬" coords="360,788,325,728,248,731,236,708,216,716,197,698,183,718,154,722,140,716,120,741,139,772,124,790,129,826,149,852,140,861,129,852,128,863,105,849,106,868,82,906,119,898,118,874,140,889,144,921,179,901,188,869,198,901,225,896,229,858,254,846,280,843,285,852,274,864,256,884,281,900,301,881,310,879,300,848,313,828,325,838,326,861,335,868,341,853,363,853,364,837,343,825,335,815,237,777,189,777,167,763,174,737,217,726,249,751,231,774,334,816" shape="poly">
                    <area target="_self" alt="ê´‘ì£¼" title="ê´‘ì£¼" href="ê´‘ì£¼ë§í¬" coords="231,752,213,738,192,738,179,753,177,761,196,769,214,768,229,767" shape="poly">
                    <area target="_self" alt="ë¶€ì‚°" title="ë¶€ì‚°" href="ë¶€ì‚°ë§í¬" coords="625,736,613,723,581,744,558,758,547,773,556,779,581,788,608,768" shape="poly">
                    <area target="_self" alt="ì œì£¼ë„" title="ì œì£¼ë„" href="ì œì£¼ë„ë§í¬" coords="208,1037,184,1023,121,1034,78,1062,99,1108,193,1076,209,1054" shape="poly">
                    <area target="_self" alt="ìš¸ë¦‰ë„,ë…ë„" title="ìš¸ë¦‰ë„,ë…ë„" href="ìš¸ë¦‰ë„, ë…ë„ë§í¬" coords="775,329,775,267,678,267,680,331" shape="poly">
                </map>
            </div>
            '''
    )

    

    #ì§€ì—­ë³„ ê·¸ë˜í”„ë¶ˆëŸ¬ì˜¤ê¸°
     #ì²˜ìŒì— regionì´ ì—†ìœ¼ë¯€ë¡œ ì˜ˆì™¸ì²˜ë¦¬
    if 'region' not in query_params:
        st.warning("ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”")

    
    elif query_params['region'] == 'seoul':
        response = requests.get(my_url + '/seoul')
        
        st.write(response.json())
        
    